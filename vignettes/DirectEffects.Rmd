---
title: "DirectEffects: Estimating controlled direct effects"
author: 
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimating controlled direct effects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r loadpkg, echo = F, include = F}
library(dplyr)
library(scales)
library(reshape2)
library(ggplot2)
library(DirectEffects) # devtools::install_github("mattblackwell/DirectEffects", ref = "develop")
```

* [Installation](#implementation)
* [Demonstration](#demonstration)
* [Quantity of Interest](#quantity-of-interest)
* [Estimation by sequential g-estimation](#estimation-by-sequential-g-estimation)
* [Case](#case)
* [Implementation](#implementation)
* [Interpretation of Output](#interpretation-of-output)

# Introduction
The `DirectEffects` package provides the tools for researchers to estimate the controlled direct effect of some treatment, net the effect of some mediator (See [Acharaya, Blackwell, and Sen (2016)](https://www.cambridge.org/core/journals/american-political-science-review/article/explaining-causal-findings-without-bias-detecting-and-assessing-direct-effects/D11BEB8666E913A0DCD7D0B9872F5D11)). This goal is often tricky in practice because there are covariates that causally affect the mediator and are causally affected by the treatment. Including such variables in a regression model, for instance, could lead to post-treatment bias when estimating the direct effect of treatment. A large class of models and estimation approaches have been developed to avoid this problem. Currently, the package only implements one approach to estimating the CDE, which is called sequential g-estimation. The idea behind this approach is that if we can estimate the effect of the mediator using a standard linear model, then to estimate the direct effect of treatment without post-treatment bias if we suitably "remove" that effect from the dependent variable. 


# Installation
The current version of the package is currently on git.
```{r, echo = TRUE, eval = F}
install_github("mattblackwell/DirectEffects", ref = "master")
library(DirectEffects)
```

# Demonstration
Below is a minimal working example of implementing a version of `DirectEffects`. In the subsequent sections, we explain the process in detail.
```{r, eval = F}
data(ploughs)
ploughs$centered_ln_inc <- ploughs$ln_income - mean(ploughs$ln_income, na.rm = TRUE)
ploughs$centered_ln_incsq <- ploughs$centered_ln_inc^2

first <- lm(women_politics~ plow + centered_ln_inc + centered_ln_incsq + agricultural_suitability +  tropical_climate +  large_animals + political_hierarchies + economic_complexity + rugged + years_civil_conflict +  years_interstate_conflict  + oil_pc + european_descent + communist_dummy + polity2_2000 + serv_va_gdp2000,
            data = ploughs)

direct <- sequential_g(formula = women_politics ~ plow + agricultural_suitability +  tropical_climate +  large_animals + political_hierarchies + economic_complexity + rugged | centered_ln_inc + centered_ln_incsq, 
                       first_mod = first, 
                       data = ploughs, subset = rownames(ploughs) %in% rownames(model.matrix(first)))
```


# Quantity of Interest
The main quantity of interest in the DirectEffect package is the Average Controlled Direct Effect (ACDE). This can be illustrated from the following causal structure (Figure 3 in Acharaya, Blackwell, and Sen).

```{r, echo = F, out.width = "600px"}
knitr::include_graphics("figures/ABS_fig3.png")
```


The Controlled Direct Effect defined for a given treatment ($A = a$ vs. $A = a^\prime$) and a given value of the mediator ($M = m$) is 
$$\mathit{CDE}_{i}(a, a^\prime, m) = Y_i(A = a, M = m) - Y_i(A = a^\prime, M = m)$$
and is the total of tehe dashed lines in the Figure above. Thus, we set the mediator constant across the two treatments. 

Contrast this with the Natural Direct Effect, implemented in mediation analysis, which is "natural"" in the sense that we let the mediator take its potential outcome under treatment.
$$\mathit{NDE}_{i}(a, a^\prime) = Y_i(A = a, M = M(a)) - Y_i(A = a^\prime, M = M(a^\prime))$$

The NDE's counterpart, the Natural Indirect Effect, is the effect that "flows through" the mediator, holding treatment constant
$$\mathit{NIE}_{i}(a, a^\prime) = Y_i(A = a, M = M(a)) - Y_i(A = a, M = M(a^\prime))$$
and involves a ``cross-world'' assumption in the second potential outcome (we never observe $A = a$ and the mediator under $A = a^\prime$ for a given individual $i$.)

The CDE is useful for discriminating between  causal mechanisms, because the average total effect $\tau(a, a^\prime) \equiv E[(Y_i(a) - Y_i(a^\prime)]$ can be decomposed as the sum of the average CDE across observations (_ACDE_), the average natural indirect effect,  and a measure of how much the direct effect of $A$ depends on a particular $M = m$:
$$\tau(a, a^\prime) = \mathit{ACDE} (a, a^\prime, M = 0) +  \mathit{ANIE} (a, a^\prime) + E[M_i(a)[ \mathit{CDE}(a, a^\prime, M = 1) -  \mathit{CDE}(a, a^\prime, M = 0)]].$$

Thus, if the _ACDE_ is non-zero, it is evidence that the effect of $A$ is not entirely explained/dominated by its mediated effect _via_ $M.$ We illustrate this with an empirical example.


# Estimation by sequential g-estimation
`DirectEffects` estimates the ACDE by sequential g-estimation, a type of structural nested mean model. 

Sequential g-estimation is relevant because it allows us to nonparametrically identify, under the sequential unconfoundedness assumption, the ACDE as follows:
$$E[Y_i(a, 0) - Y_i(0,0)|X_i = x] = E[Y_i - \gamma(a, M_i, x) | A_i = a, x] - E[Y_i - \gamma(0, M_i, x) | A_i = 0, x]$$

The function $\gamma$ above is called the "demediation function" (or "blip-down function") and is computed as follows.
$$\gamma(a, m, x) = E[Y_i(a, M_i = m)  = Y_i(a, M_i = 0) | X_i = x]$$

This function computes the effect of switching from some level of the mediator to 0, and thus is an estimate of the causal effect of the mediator. conditional on the treatment and with treatment held constant. Subtracting its estimates $\gamma(A_i, M_i, X_i)$ from the outcome $Y_i$ will effectively remove the variation due to the mediator.

The identification of the ACDE hold under the sequential unconfoundedness condition, using the definitions by Acharaya, Blackwell, and Sen.

**Assumption 1 (Sequential Unconfoundedness)** 

> First, no omitted variables for the effect of treatment ($A$) on the outcome ($Y$), conditional on the pretreatment confounders ($X$). Second, no omitted variables for the effect of the mediator on the outcome, conditional on the treatment, pretreatment confounders, and intermediate confounders ($Z$).


While the _average_ CDE is estimated nonparametrically with this assumption, we need to make a further assumption to accurately characterize the de-mediation function.

**Assumption 2 (No intermediate interactions)**

> The effect of the mediator ($M$) on the outcome ($Y$) is independent of the intermediate confounders ($Z$).


## Estimating the de-mediation function
However, estimating the de-mediation function itself is hard, because it asks the potential outcomes of the same individuals under different values of the mediator. Under the assumption of _sequential unconcoundedness_, however, it is nonparametrically identified with the usual conditional difference-in-means estimator. This assumption in this context invokes the selection on observables assumption that is necessary to interpret multiple regression coefficients as an average treatment effect. 

When there are no interactions between the mediator and the treatment, nor between the mediator and the pretreatment confounders, the de-mediation function is straightforward to estimate. It is simply $\gamma(a, m, x) = km$, where $k$ is the estimate of the OLS coefficient on the mediator. 

## Using the de-mediation function to estimate ACDE
The second stage of sequential g-estimation uses the de-mediated outcome
$$\tilde{Y_i} = Y_i - \hat{\gamma}(A_i, M_i, X_i; \hat{\alpha})$$
and estimates its conditional mean function by regressing it on the treatment and pre-treatment covariates.
$$E[\tilde{Y_i} | A_i, X_i] = \beta_0 + \beta_1A_i + X_i^T\beta_2$$
under the assumptions, the $\hat{\beta_1}$  is an estimate of the ACDE. 
$$\hat{\mathit{ACDE}} = \hat{\beta_1}$$



# Case
The data comes from [Alesina, Giuliano, and Nunn, 2013](http://scholar.harvard.edu/files/nunn/files/alesina_giuliano_nunn_qje_2013.pdf?m=1366834674). The dataset comes with the package:
```{r}
data(ploughs)
```

The paper's main argument is that the advent of the capital-intensive agricultural practice of the plow favored men over women participating in agriculture, which have affected gender inequality in modern societies. They also suggest that the effect of the plow agriculture flows through income. Thus, in this example, 

* $Y_i$ is the share of political positions held by women in 2000 (`women_politics`)
* $A_i$ is the relative proportion of ethnic groups that traditionally used the plow within a country (`plow`)
* $M_i$ is the log GDP per capita in 2000 (`ln_income`)
* $X_i$ is the pre-treatment characteristics of the country, which are mostly geographic. (`tropical_climate`, `agricultural_suitability`, `large_animals`, `political_hierarchies`, `economic_complexity`, and `rugged`)

where $i$ indexes countries.
```{r}
tbl_df(ploughs)
```

A bivariate relationship between the treatment and the dependent variable show no clear relationship. We seek to estimate the causal effect of a nation adopting a plow, controlling for pre-treatment confounders and accounting for mediators such as national income.

```{r, echo = F, fig.width= 7, fig.height=4, warning=F}
ggplot(ploughs, aes(x = plow, women_politics/100, size = exp(ln_income))) + 
  labs(
    title = "Agricultural practice and modern gender equity",
    caption = "Source: Alesina, Giuliano, and Nunn (2013)",
    y = "Political positions held by women (2000)",
    x = "Ethnic groups that traditionally used the plough"
  ) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(label = percent) +
  scale_y_continuous(label = percent) +
  scale_size_continuous(name = "Country Income (USD)") +
  theme_light()
```


As a baseline, we first regress $Y$ on $A$ controlling for the pre-treatment variables $X$.
```{r}
ate.mod <- lm(women_politics ~ plow + agricultural_suitability +  tropical_climate +  large_animals + political_hierarchies + economic_complexity + rugged, data = ploughs)
```

Notice that the effect of the plow is negative and insignificant.
```{r, echo = TRUE, eval = TRUE}
summary(ate.mod)
```




# Implementation
## Setup

In this example, we would like to make this assumption and conduct a hypothesis test on whether or not the controlled direct effect of plows net income is substantive. One way to make this inference slightly easier to accomplish is to recenter our mediator, (log income), so that when we demediate with $m = 0$, this will equivalent to demediation with $m$ set to its mean value. Thus, we center the mediator to 0 and use this _centered_ variable as our mediator. Furthermore, we create a squared term of this centered mediator so that we can include it in the demediation function.

```{r, echo = TRUE, eval = TRUE}
ploughs$centered_ln_inc <- ploughs$ln_income - mean(ploughs$ln_income, na.rm = TRUE)
ploughs$centered_ln_incsq <- ploughs$centered_ln_inc^2
```

## First stage model
The first stage is a linear model of the outcome on both the  $Y$ on $A$ (`plow`), $M$ (`centered_ln_inc` + `centered_ln_incsq`), and $X$: 
```{r, echo = TRUE, eval = TRUE}
fit_first <- lm(women_politics~ plow + centered_ln_inc + centered_ln_incsq + agricultural_suitability +  tropical_climate +  large_animals + political_hierarchies + economic_complexity + rugged +years_civil_conflict +  years_interstate_conflict  + oil_pc + european_descent + communist_dummy  + polity2_2000 + serv_va_gdp2000, 
                data = ploughs)
```


## Second stage model
Next, we specify the main formula that, in contrasts to the first stage model, distinguishes between the mediator and other predictors.  The formula should regress $Y$ on $X$ but mediated through $M$, expressed as `yvar ~ xvars | mvars`. The mediators must be named the same way as in the first model. 

```{r}
form_main <- women_politics ~ plow + agricultural_suitability +  tropical_climate +  large_animals + political_hierarchies + economic_complexity + rugged | centered_ln_inc + centered_ln_incsq
```


## Sequential g-estimation
Finally, we enter the two formula for each step into the sequential g-estimation function. It takes the main model specification as the first argument (`formula`), followed by the first stage model used for estimating the de-mediation function (`first_mod`).

```{r, echo = TRUE, eval = TRUE}
direct <- sequential_g(formula = form_main,
                       first_mod = fit_first,
                       data = ploughs,
                       subset = rownames(ploughs) %in% rownames(model.matrix(fit_first)))
```

This function, `sequential_g(formula, first_mod, data, ...)`, implements sequential g-estimation in the way outlined in the previous section. Specifically, it first takes the first stage model and constructs the de-mediator function.


## How sequential g-estimation operates
(Users wishing to interpret the output of the `DirectEffects` package can skip to the next section.)


How did `sequential_g` estimate the ACDE? The key components of the process center on the de-mediation function. The demediating function used here is the conditional expectation function. We take the coefficients of the mediator from the OLS regression of `Y` on `M`, controlling also for `A` and `X`. In our example the mediators are the log of income and its square, thus the de-mediation function can be expressed as the parabola:
```{r, echo = F, fig.width= 7, fig.height=4, warning=F}
mnames <- c("centered_ln_inc", "centered_ln_incsq")
coefs <- coefficients(fit_first)[mnames]
avgs <- colMeans(model.frame(fit_first))
avgs[mnames] <- 0
avgs[1] <- 1

curve.first <- function(x) {
  yhat <- coefs[1]*x + coefs[2]*x^2 + sum(coef(fit_first)*avgs)
  return(yhat)
}

ploughs %>% 
  ggplot(., aes_string(x = mnames[1], y = "women_politics")) + 
  geom_point() +
  stat_function(fun = curve.first, size = 1, color = "indianred", size = 2) +
  labs(title = "De-mediation function (line) overlayed on bivariate relationship (points)") +
  annotate('text', x = 2, y = -1, 
           label = paste0("gamma(m)==", coefs[1], "*m + ", coefs[2], "*m^{2}"),
           parse = TRUE,
           color = "indianred")  +
  theme_light()
```

Using the de-mediation function, `sequential_g` de-mediates the outcome variable for the second stage. 
```{r, eval = F}
  rawY <- model.response(mf, "numeric")
  M <- model.matrix(object = bt, data = mf, contrasts)
  gamma <- M %*% fcoefs[bvars] # fitted values from de-mediation function 
  Y <- rawY - gamma
```

In this case, this modifies each value of the dependent variable as follows:
```{r, echo = F, fig.width= 7, fig.height=4}
rawYdat <- ploughs$women_politics
mDat <- select_(ploughs, .dots = mnames) %>% as.matrix()
mCoefs <- coefficients(fit_first)[mnames]
gammaDat <- mDat %*% mCoefs 
Ydat <- rawYdat - as.numeric(gammaDat)

# plot
data_frame(Ydat, rawYdat, id = 1:length(rawYdat)) %>%
  melt(., id = "id") %>% 
  filter(!is.na(value)) %>% 
  ggplot(., aes(y = variable, x = value, group = id)) +
  geom_path(arrow = arrow(angle = 15, length = unit(0.2,"cm"), type = "closed",ends =  "first"),
            color = "darkgray", alpha = 0.4) +
  geom_hline(yintercept = 1:2) +
  geom_point() +
  scale_y_discrete(name = "", labels = c("de-mediated values", "original values")) +
  labs(x = "Dependent Variable: Percent of Women in Politics",
       title = "Implications of de-mediation") +
  theme_light()
```


The second stage involves regressing the de-mediated dependent variable on the treatment and pre-treatment variables:
```{r, eval = F}
  mtX <- terms(formula, data = data, rhs = 1) # Y ~ A + X
  X <- model.matrix(mtX, mf, contrasts) # numeric matrix
  out <- lm.fit(X, Y, offset = offset, ...)
```





# Interpretation of Output 
Functions `summary` and `print` can be applied to a DirectEffects object:
```{r, echo = TRUE, eval = TRUE}
summary(direct)
```

The coefficient on the treatment variable (here, `plow`), is the estimate of the ACDE. The results show a negative ACDE of plows, where we have define "direct" in the sense of not flowing through the mediators of income. It is now larger than its effect found from the total effect:
```{r, echo = F, fig.width= 7, fig.height=4}
df.coef <- rbind(summary(ate.mod)$coef["plow", ],
               summary(direct)$coef["plow", ]) %>% 
  as.data.frame()  %>%
  mutate(pos = c("ATE of Plows", "ACDE of Plows, via sequential g-estimation"))

ggplot(df.coef, aes(x = Estimate, y = 0)) +
  facet_wrap(~ pos, ncol = 1) +
  geom_point() +
  geom_segment(data = df.coef, aes(x = Estimate + 1.96*`Std. Error`, xend = Estimate - 1.96*`Std. Error`, y = 0, yend = 0)) +
  scale_y_continuous(labels = NULL, limit = c(-1, 1), breaks = NULL, minor_breaks = NULL) +
  scale_x_continuous(limit = c(-10, 5)) +
  geom_vline(xintercept = 0, color = "red", linetype = 2) +
  geom_label(aes(label = round(Estimate, 1)), y = 0.3) +
  theme_light() +
  labs(title = "Estimated Causal Effects on Percent of Women in Political Office",
      x = "",
      y = "",
      caption = "Lines are 95% confidence intervals")
```


The estimates are stored in the same way as a `lm` object:
```{r}
direct$coefficients
```
It also stores the variance covariance-matrix, 
```{r}
direct$vcov
```

as well as the the data used, the de-mediated dependent variable, and the model matrix of the treatment and pre-treatment covariates if specified in the function (`model = T`, `x = T`, `y = T`):
```{r}
head(direct$model)
head(direct$y)
head(direct$x) # will be non-NULL if the argument x in sequential_g is set to TRUE
```



The specifications of the various models is stored in `terms`
```{r}
names(direct$terms)
class(direct$terms$direct)
```





